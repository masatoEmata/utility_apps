<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Facebook Pixel - イベントタグ（動的広告タグ）ジェネレーター</title>
    <style>
        .invisible{
            display: none;
        }
    </style>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KH546HW');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <h1>Facebook Pixel - イベントタグ（動的広告タグ）ジェネレーター</h1>
    <form>
        <fieldset>
            <legend>標準イベント名を選んでください</legend>
            <input type="radio" id="event_name1" name="event_name" value="ViewContent" /><label
                for="event_name1">ViewContent</label><br>
            <input type="radio" id="event_name2" name="event_name" value="AddToCart" /><label
                for="event_name2">AddToCart</label><br>
            <input type="radio" id="event_name3" name="event_name" value="Purchase" /><label
                for="event_name3">Purchase</label><br>
        </fieldset>
        <fieldset>
            <legend>送信する商品IDの粒度を選んでください</legend>
            <input type="radio" id="content_type1" name="content_type" value="" class="properties" /><label
                for="content_type1">商品IDを送信しない</label><br>
            <input type="radio" id="content_type2" name="content_type" value="product" class="properties" /><label
                for="content_type2">SKU</label><br>
            <input type="radio" id="content_type3" name="content_type" value="product_group" class="properties" /><label
                for="content_type3">グループID</label><br>
        </fieldset>
        <fieldset>
            <legend>商品数量も送信するか選んでください</legend>
            <input type="radio" id="quantity1" name="quantity" value="" class="property_map" /><label
                for="quantity1">IDも数量も送信しない</label><br>
            <input type="radio" id="quantity2" name="quantity" value="content_ids:【変数 配列型 ex.['1234567891234',...]】"
                class="property_map" /><label for="quantity2">数量を送信しない</label><br>
            <input type="radio" id="quantity3" name="quantity" value="contents:【変数 JSONオブジェクト配列型 ex.[{'id':'1234567891234','quantity':3},...]】"
                class="property_map" /><label for="quantity3">数量を送信する</label><br>
        </fieldset>
        <fieldset>
            <legend>ページ/商品名も送信するか選んでください</legend>
            <input type="radio" id="content_name1" name="content_name" value="" class="properties" /><label
                for="content_name1">送信しない</label><br>
            <input type="radio" id="content_name2" name="content_name" value="【変数 テキスト型 ex.トレンチコートXXX】"
                class="properties" /><label for="content_name2">送信する</label><br>
        </fieldset>
        <fieldset>
            <legend>金額を送信するか選んでください（「Purchase」イベントは必須）</legend>
            <input type="radio" id="value1" name="value" value="" class="properties" /><label
                for="value1">送信しない</label><br>
            <input type="radio" id="value2" name="value" value="【変数 数値型 ex.128000】" class="properties" /><label
                for="value2">送信する</label><br>
        </fieldset>
        <fieldset>
            <legend>通貨コードを送信するか選んでください（「Purchase」イベントは必須）</legend>
            <input type="radio" id="currency1" name="currency" value="" class="properties" /><label
                for="currency1">送信しない</label><br>
            <input type="radio" id="currency2" name="currency" value="JPY" class="properties" /><label
                for="currency2">JPY</label><br>
            <input type="radio" id="currency3" name="currency" value="USD" class="properties" /><label
                for="currency3">USD</label><br>
        </fieldset>
        <fieldset>
            <legend>複数のピクセルタグ設置に対応するか選んでください</legend>
            <input type="radio" id="trackSingle1" name="trackSingle" value="" /><label
                for="trackSingle1">対応しない</label><br>
            <input type="radio" id="trackSingle2" name="trackSingle" value="trackSingle" /><label
                for="trackSingle2">対応する</label><br>
        </fieldset>
        <fieldset class="invisible">
            <legend>上記「対応する」場合、Facebook Pixel ID を入力してください</legend>
            <input type="text" id="pixel_id1" name="pixel_id" />
        </fieldset>
        <button id="generate" type="button">Facebook Pixel Tag を生成する</button>
    </form>
</body>

<script>
    (function () {
        window.onload = function (e) {

            //選択肢の依存関係の制御 - 選択肢をチェック
            var content_type_elm = document.querySelector("input#content_type1");
            content_type_elm.onchange = function () {
                document.querySelector("input#quantity1").checked = "checked";
            }
            var content_type_elm = document.querySelector("input#event_name3");
            content_type_elm.onchange = function () {
                document.querySelector("input#value2").checked = "checked";
                document.querySelector("input#currency3").checked = "checked";
            }
            //選択肢の依存関係の制御 - 表示・非表示
            var track_elm = document.querySelector("input#trackSingle1");
            var trackSingle_elm = document.querySelector("input#trackSingle2");
            track_elm.onchange = function () {
                document.querySelector(".invisible").style.display = "none";
            }
            trackSingle_elm.onchange = function () {
                document.querySelector(".invisible").style.display = "block";           
            }

            //生成ボタンクリックによりタグファイルをダウンロード
            var generate_button = document.querySelector("button#generate");
            generate_button.onclick = function () {
                alert("生成、および、ダウンロードしました");
                let blob = new Blob([generate_pixel_tag()], { type: "text/plan" });
                let link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Facebook Event Tag.txt';
                link.click();
            }

            //入力値をもとにピクセルタグを生成
            function generate_pixel_tag() {
                const track = function () {
                    const trackSingle = document.querySelector("input[name=trackSingle]:checked").value;
                    if (trackSingle) {
                        const pixel_id = document.querySelector("input[name=pixel_id]").value;
                        return "'trackSingle', '" + pixel_id + "',";
                    } else {
                        return "track";
                    }
                };
                const event_name = document.querySelector("input[name=event_name]:checked").value;
                const properties = {};
                Array.from(document.querySelectorAll("input.properties[type=radio]:checked")).map(function (elm) {
                    if (elm.value) properties[elm.name] = elm.value;
                });
                Array.from(document.querySelectorAll("input.property_map[type=radio]:checked")).map(function (elm) {
                    const propery_map_key = elm.value.split(":")[0];
                    const propery_map_value = elm.value.split(":").slice(1).join();
                    if (propery_map_value) properties[propery_map_key] = propery_map_value;
                });
                return "fbq(" + track() + " " + event_name + ", " + JSON.stringify(properties) + ");";
            }

        }
    }());
</script>

</html>
